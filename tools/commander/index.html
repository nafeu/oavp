<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>oavp-commander</title>
  <style>
    body {}

    #buttons {
      display: flex;
      gap: 5px;

      button {
        font-size: 1.25rem;
      }
    }

    #data {
      width: 75vw;
      overflow: auto; /* Optional: Add scrollbars for overflow */
      white-space: pre-wrap; /* Optional: Preserve line breaks and wrap long lines */
      cursor: pointer;
      border: 1px solid #ccc;
      padding: 10px;
    }
  </style>
</head>
<body>

<div id="buttons">
  <button id="buttonE" onclick="sendApiCommand({ command: 'export' })">Export</button>
  <button id="buttonG" onclick="sendApiCommand({ command: 'generate' })">Generate</button>
  <button id="buttonR" onclick="sendSocketCommand({ command: 'reset' })">Reset</button>
  <button id="buttonP" onclick="sendSocketCommand({ command: 'save-preset' })">Save Preset</button>
  <button id="button2" onclick="sendSocketCommand({ command: 'randomize-palette' })">Randomize Palette</button>
  <button id="button1" onclick="sendSocketCommand({ command: 'randomize-colors' })">Randomize Colors</button>
</div>
<pre style="color: purple;" id="sketch-socket"></pre>
<pre style="color: blue;" id="commander-socket"></pre>
<pre id="response"></pre>
<pre id="data"></pre>

<script>
  const sketchSocket = new WebSocket('ws://localhost:3000/commands');

  sketchSocket.addEventListener('open', (event) => {
    document.getElementById('sketch-socket').textContent = "[ socket ] WebSocket connection opened.";
    console.log('WebSocket connection opened:', event);
  });

  sketchSocket.addEventListener('message', (event) => {
    const receivedData = JSON.parse(event.data);
    console.log('Received:', receivedData);
  });

  sketchSocket.addEventListener('error', (event) => {
    document.getElementById('sketch-socket').textContent = "[ socket ] WebSocket error.";
    console.error('WebSocket error:', event);
  });

  sketchSocket.addEventListener('close', (event) => {
    document.getElementById('sketch-socket').textContent = "[ socket ] WebSocket connection closed.";
    console.log('WebSocket connection closed:', event);
  });

  const commanderSocket = new WebSocket('ws://localhost:3002');

  commanderSocket.addEventListener('open', (event) => {
    document.getElementById('commander-socket').textContent = "[ commander ] WebSocket connection opened.";
    console.log('WebSocket connection opened:', event);
  });

  commanderSocket.addEventListener('message', (event) => {
    const dataElement = document.getElementById('data');
    const receivedData = JSON.parse(event.data);

    if (receivedData.command === 'preset-builder-result') {
      dataElement.textContent = receivedData.data;
    }
  });

  commanderSocket.addEventListener('error', (event) => {
    document.getElementById('commander-socket').textContent = "[ commander ] WebSocket error.";
    console.error('WebSocket error:', event);
  });

  commanderSocket.addEventListener('close', (event) => {
    document.getElementById('commander-socket').textContent = "[ commander ] WebSocket connection closed.";
    console.log('WebSocket connection closed:', event);
  });

  function sendSocketCommand({ command, ...params }) {
    const responseElement = document.getElementById('response');
    responseElement.style.color = 'purple';
    responseElement.textContent = `SOCKET @ ${new Date().toLocaleString()} : ${command}`;
    sketchSocket.send(JSON.stringify({ command, ...params }));
  }

  function sendApiCommand({ command, ...params }) {
    fetch('/api/command', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ command, ...params }),
    })
    .then(response => response.json())
    .then(data => {
      const responseElement = document.getElementById('response');
      const dataElement = document.getElementById('data');
      if (data.status === 'success') {
        responseElement.style.color = 'green';
      } else if (data.status === 'warning') {
        responseElement.style.color = 'yellow';
      } else {
        responseElement.style.color = 'red';
      }
      responseElement.textContent = `API @ ${new Date().toLocaleString()} : ${data.message}`;

      if (data.data) {
        if (command === 'generate') {
          let dataElementText = '';

          data.data.forEach(item => {
            dataElementText += `${item.id}\n${item.params.map((param, index) => `[${param.id} : ${param.value}]`).join(' ').trim()}\n\n`;
          })

          dataElementText += `Total Objects: ${data.data.length}`;
          dataElement.textContent = dataElementText;
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      const responseElement = document.getElementById('response');
      responseElement.style.color = 'red';
      responseElement.textContent = 'Error occurred during API request.';
    });
  }

  document.addEventListener('keydown', function(event) {
    const key = event.key.toLowerCase(); // Convert to lowercase for case-insensitivity
    if (key === 'e' || key === 'g') {
      const buttonId = `button${key.toUpperCase()}`;
      const button = document.getElementById(buttonId);
      if (button) {
        button.click();
      }
    }
  });

  document.getElementById('data').addEventListener('click', function () {
    const originalText = document.getElementById('data').textContent;
    const textarea = document.createElement('textarea');
    textarea.value = this.textContent;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    this.textContent = 'Copied to Clipboard!';
    setTimeout(() => {
      this.textContent = originalText;
    }, 1000);
  });
</script>

</body>
</html>
